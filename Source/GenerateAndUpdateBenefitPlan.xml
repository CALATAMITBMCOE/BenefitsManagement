<gel:script
 xmlns:core="jelly:core"
    xmlns:gel="jelly:com.niku.union.gel.GELTagLibrary"
    xmlns:soap="jelly:com.niku.union.gel.SOAPTagLibrary"
    xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/"
    xmlns:soap-env="http://schemas.xmlsoap.org/soap/envelope/"
    xmlns:sql="jelly:sql"
    xmlns:xog="http://www.niku.com/xog"
    xmlns:xsd="http://www.w3.org/2001/XMLSchema"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:file="jelly:com.niku.union.gel.FileTagLibrary"
    xmlns:util="jelly:util"
    xmlns:q="http://www.niku.com/xog/Query"
    xmlns:fn="http://java.sun.com/jsp/jstl/functions">

    <core:set var="vBenefitPlanIntl" value="${gel_objectInstanceId}"/>
    <core:if test="${DebugLevel &gt; 0}">
      <gel:log level="debug" message="Start Script"/>
      <gel:log level="debug" message=">>Benefit Plan ID     : ${vBenefitPlanIntl}"/>
      <gel:log level="debug" message=">>Persisted XOG URL   : ${XOGURL}"/>
      <gel:log level="debug" message=">>Persisted LOG Folder: ${XOGlogFolder}"/>
      <gel:log level="debug" message=">>Persisted WEB Folder: ${XOGwebFolder}"/>
      <gel:log level="debug" message=">>Persisted SessionID : ${sessionID}"/>
      <gel:log level="debug" message=">>Persisted DebugLevel: ${DebugLevel}"/>
    </core:if>

    <gel:setDataSource dbId="Niku"/>

    <sql:query escapeText="false" var="vBPlan">
      select FP.name, FP.code, BP.BENF_GROUP, BP.BENF_PLAN_PROFILE
      FROM FIN_PLANS FP inner join ODF_CA_BENEFITPLAN BP on BP.ID = FP.ID
      WHERE FP.ID = ${vBenefitPlanIntl}
    </sql:query>
    <core:forEach items="${vBPlan.rowsByIndex}" var="row">
      <core:set var="vPlanName">${row[0]}</core:set>
      <core:set var="vPlanCode">${row[1]}</core:set>
      <core:set var="vPlanBGrp">${row[2]}</core:set>
      <core:set var="vPlanBPrf">${row[3]}</core:set>
      <gel:log level="debug" message="Found Plan: ${vPlanName}-${vPlanCode} with Group ${vPlanBGrp} and Profile ${vPlanBPrf}"/>
    </core:forEach>

    <sql:query escapeText="false" var="vBCalc">
      select FBPD.ID, BPD.OBJ_BENEFIT_CLASS, BPD.OBJ_BENEFIT_SUBCLASS, BPD.BENF_CALC, BPD.BENF_CATEGORY, BC.formula
      from fin_benefit_plan_details fbpd
        inner join odf_ca_benefitplandetail BPD on bpd.id = fbpd.id
        inner join odf_ca_benf_calc BC on BC.ID = BPD.benf_calc
      Where FBPD.PLAN_ID = ${vBenefitPlanIntl}
    </sql:query>
    <core:forEach items="${vBCalc.rowsByIndex}" var="row">
      <core:set var="vPlanDetIntl">${row[0]}</core:set>
      <core:set var="vPlanDetClas">${row[1]}</core:set>
      <core:set var="vPlanDetSubc">${row[2]}</core:set>
      <core:set var="vPlanDetBenf">${row[3]}</core:set>
      <core:set var="vPlanDetCatg">${row[4]}</core:set>
      <core:set var="vBenfFormula">${row[5]}</core:set>
      <gel:log level="debug" message="Found Benefit Detail: ${vPlanDetIntl} ${vPlanDetClas} ${vPlanDetSubc} ${vPlanDetCatg} Benefit Calculation: ${vPlanDetBenf} ${vBenfFormula}"/>

      <sql:query escapeText="false" var="vVars">
        select BV.CODE, BPV.ID
        from ODF_CA_BENF_PLAN_VAR BPV INNER JOIN odf_ca_benf_variable BV on BV.ID = BPV.BENF_VARIABLE
          inner join odf_MULTI_VALUED_LOOKUPS MVL
          ON MVL.attribute='variables' and MVL.object='benf_calc' and MVL.PK_ID = ${vPlanDetBenf}
          AND BV.ID = MVL.VALUE
      </sql:query>
      <core:forEach items="${vVars.rowsByIndex}" var="row">
        <core:set var="vVarCode">${row[0]}</core:set>
        <core:set var="vVarIntl">${row[1]}</core:set>
        <gel:log level="debug" message="-- Found Benefit Variable: ${vVarCode} vVarIntl: ${vVarIntl}"/>
        <core:set var="vTemp" value="(SELECT CURRENT_VALUE FROM ODF_CA_BENF_PLAN_VAR WHERE ID=${vVarIntl})"/>

        <core:invoke var="vBenfFormula" on="${vBenfFormula}" method="replaceAll">
          <core:arg type="java.lang.String" value="${vVarCode}"/>
          <core:arg type="java.lang.String" value="${vTemp}"/>
        </core:invoke>

      </core:forEach>
      <gel:log level="debug" message="Final Benefit Formula: ${vBenfFormula}"/>

      <sql:query escapeText="false" var="vResult">
        select ${vBenfFormula}
        from DUAL
      </sql:query>
      <core:forEach items="${vResult.rowsByIndex}" var="row">
        <core:set var="vFinalResult">${row[0]}</core:set>
      </core:forEach>
      <gel:log level="debug" message="Final Benefit Result: ${vFinalResult}"/>

      <sql:update>
           UPDATE ODF_CA_BENEFITPLANDETAIL SET BENF_CALC_YEARLY=${vFinalResult} WHERE ID=${vPlanDetIntl}
      </sql:update>
  </core:forEach>

</gel:script>
